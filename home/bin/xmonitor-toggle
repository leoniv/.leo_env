#!/usr/bin/env bash

set -e

PRIMARY_DEF=eDP
LID_PATH=/proc/acpi/button/lid/LID/state
OPEN=open
CLOSE=close

getPrimary() {
  actual=getConnectedPrimary
  if [ -z "$actual" ]; then
    PRIMARY_DEF
  else
    $actual
  fi
}

getConnected() {
  lidState=$(cat $LID_PATH | awk '{print $2}')
  actual=$(xrandr -q | grep -e "\Wconnected" | awk '{print $1}')
  if [ "$lidState" == $OPEN ]; then
    echo $actual
  else
    echo $actual | sed "s/$PRIMARY_DEF//g"
  fi
}
CONNECTED=$(getConnected)

getActive() {
  echo $(xrandr --listactivemonitors | awk '{print $4}')
}
ACTIVE=$(getActive)

getVeryLeftActive(){
  echo $ACTIVE | awk "{print $1}"
}

getConnectedPrimary() {
  echo $(xrandr -q | grep -e "\Wconnected" | grep "\Wprimary" | awk '{print $1}')
}

getRightOrLeftOf() {
  if [ "$1" == "$(getPrimary)" ]; then
    veryLeft=`getVeryLeftActive`
    if [ -z $veryLeft ]; then
      echo "--primary"
    else
      echo "--primary --left-of $veryLeft"
    fi
    exit
  fi
  echo "--right-of $(getPrimary)"
}

offDisconnected() {
  for i in $ACTIVE; do
    if [ -z "$(echo $CONNECTED | grep $i)" ]; then
      echo off monitor: $i
      xrandr --output $i --off
     fi
  done
}

onConnected() {
  for i in $CONNECTED; do
    if [ -z "$(echo `getActive` | grep $i)" ]; then
       echo on monitor: $i
       xrandr --output $i $(getRightOrLeftOf $i) --auto
     fi
  done
}

fallbackOnDefault() {
  if [ -z "$(getActive)" ]; then
    echo "emegency on: $PRIMARY_DEF"
    xrandr --output $PRIMARY_DEF --primary --auto
  fi
}

offDisconnected
onConnected
fallbackOnDefault
